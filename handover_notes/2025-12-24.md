# ================================
# Handover Notes
# ================================

## プロジェクト概要
- Flask + SQLAlchemy のタスク管理アプリ
- 認証（登録 / ログイン / ログアウト）実装予定
- Docker + Nginx で HTTPS 対応
- GitHub Flow（main + feature ブランチ運用）

---

## 現在の作業ブランチ
- ブランチ名  
  feature/flask-blueprint-refactor

- 作業概要  
  Blueprint 化および Application Factory パターン導入による  
  アプリ構成のリファクタリング

---

## 作業背景・判断理由
- 機能追加（メール送信）前に、構成の健全性・保守性を優先
- 単一 app.py 構成では責務が集中し、拡張時に破綻しやすいため
- 実務で一般的な Blueprint + Factory 構成への移行を目的とする

---

## 本日の対応内容
- Flask CLI の起動仕様を詳細に整理
  - FLASK_APP の役割
  - import 失敗時の挙動
  - wsgi.py 経由での起動との関係
- Application Factory（create_app）構成を整理・安定化
- extensions.py による SQLAlchemy / LoginManager の単一インスタンス管理へ修正
- main Blueprint を作成
  - `/` ルーティングを実装
  - ログイン状態に応じたリダイレクト制御を実装
- Flask-Login の内部挙動を検証
  - user_loader 未定義時の例外発生を確認
  - current_user.is_authenticated の挙動を理解
- シークレットウィンドウを用いて
  - セッション有無による挙動差を確認
  - 現在の挙動が正常であることを確認

---

## 実装済み / 確認済み事項
- Blueprint + Factory パターン構成でのアプリ起動確認
- wsgi.py 経由での起動経路固定
- Flask CLI が FLASK_APP を基準に import を行うことを確認
- Flask-Login の仕様理解
  - current_user はセッション Cookie から復元される
  - 既存セッションがある場合、明示的なログイン処理なしでも authenticated になる
- SQLAlchemy は extensions.py のインスタンスを一元利用する必要があることを確認

---

## 未対応 / 次にやること
- Flask-Login の正式実装
  - User モデル（UserMixin + db.Model）
  - user_loader の恒久配置検討
- auth Blueprint 実装
  - /login
  - /logout
- tasks Blueprint 実装
  - /tasks ルーティング
  - @login_required 適用
- Flask-Mail 導入
- MailHog を用いたメール送信・受信確認
- Gunicorn 本番起動コマンドの追加
- feature ブランチ完了後、main へマージ

---

## 起動・確認手順
### Docker 起動
docker-compose up --build

### アプリ確認
http://localhost:5001  
https://localhost

---

## Git 操作メモ
git status  
git branch  

### feature → main マージ手順
git checkout main  
git pull  
git merge feature/flask-blueprint-refactor  
git push  

---

## 注意点
- .env / 証明書 / 永続ボリュームは Git 管理外
- main ブランチは常にデプロイ可能な状態を維持
- 作業途中のコードは必ず feature ブランチで管理
- 起動経路は wsgi.py に集約
- Flask CLI の自動探索挙動には依存しない構成としている
