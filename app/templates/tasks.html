<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <link
        href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
        rel="stylesheet"
    />
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stylesheet.css') }}">

</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-8 px-4">
        <div class="max-w-7xl mx-auto">
<!-- „Éò„ÉÉ„ÉÄ„Éº -->
<div
    class="header-gradient rounded-2xl p-8 mb-8 text-white shadow-xl"
>
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold mb-2">
                <i class="fas fa-tasks mr-3"></i>„Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
            </h1>
        </div>
        <div class="flex space-x-4">

            <!-- Êñ∞Ë¶è„Çø„Çπ„ÇØ -->
            <button
                class="bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold hover:bg-blue-50 transition-all duration-200 shadow-lg btn-hover"
                id="newTaskBtn"
            >
                <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê
            </button>

            <!-- üîµ „Éó„É≠„Éï„Ç£„Éº„É´„Éú„Çø„É≥ -->
            <button
                class="bg-green-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-600 transition-all duration-200 shadow-lg btn-hover"
                id="profileBtn"
            >
                <i class="fas fa-user mr-2"></i>„Éó„É≠„Éï„Ç£„Éº„É´
            </button>

            <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà -->
            <button
                class="bg-red-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-red-600 transition-all duration-200 shadow-lg btn-hover"
                id="logoutBtn"
            >
                <i class="fas fa-sign-out-alt mr-2"></i>„É≠„Ç∞„Ç¢„Ç¶„Éà
            </button>
        </div>
    </div>
</div>


            <!-- Áµ±Ë®à„Ç´„Éº„Éâ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div
                    class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-blue-500"
                >
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-list-ul text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">Á∑è„Çø„Çπ„ÇØÊï∞</p>
                            <p class="text-2xl font-bold text-gray-800">{{ total_count }}</p>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-red-500"
                >
                    <div class="flex items-center">
                        <div class="bg-red-100 p-3 rounded-full">
                            <i
                                class="fas fa-exclamation-triangle text-red-600 text-xl"
                            ></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">È´òÂÑ™ÂÖàÂ∫¶</p>
                            <p class="text-2xl font-bold text-gray-800">{{ high_priority_count }}</p>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-yellow-500"
                >
                    <div class="flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">ÈÄ≤Ë°å‰∏≠</p>
                            <p class="text-2xl font-bold text-gray-800">{{ in_progress_count }}</p>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-green-500"
                >
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full">
                            <i
                                class="fas fa-check-circle text-green-600 text-xl"
                            ></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-600 text-sm">ÂÆå‰∫Ü</p>
                            <p class="text-2xl font-bold text-gray-800">{{ completed_count }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- „Éï„Ç£„É´„Çø„Éº„Å®„ÇΩ„Éº„Éà -->
            <div class="bg-white rounded-xl p-6 mb-8 shadow-lg">
                <div
                    class="flex flex-wrap items-center justify-between gap-4"
                >
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-filter text-gray-600"></i>
                            <span class="text-gray-700 font-medium">„Éï„Ç£„É´„Çø„Éº:</span>
                        </div>
                        <form method="GET">
                        <select
                            name="status" onchange="this.form.submit()"
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="" {% if status_filter == "" %}selected{% endif %}>ÂÖ®„Å¶„ÅÆÁä∂ÊÖã</option>
                            <option value="ÈÄ≤Ë°å‰∏≠" {% if status_filter == "ÈÄ≤Ë°å‰∏≠" %}selected{% endif %}>ÈÄ≤Ë°å‰∏≠</option>
                            <option value="ÂÆå‰∫Ü" {% if status_filter == "ÂÆå‰∫Ü" %}selected{% endif %}>ÂÆå‰∫Ü</option>
                            <option value="‰øùÁïô" {% if status_filter == "‰øùÁïô" %}selected{% endif %}>‰øùÁïô</option>
                        </select>

                        <select
                            name="priority" onchange="this.form.submit()"
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="" {% if priority_filter == "" %}selected{% endif %}>ÂÖ®„Å¶„ÅÆÂÑ™ÂÖàÂ∫¶</option>
                            <option value="È´ò" {% if priority_filter == "È´ò" %}selected{% endif %}>È´ò</option>
                            <option value="‰∏≠" {% if priority_filter == "‰∏≠" %}selected{% endif %}>‰∏≠</option>
                            <option value="‰Ωé" {% if priority_filter == "‰Ωé" %}selected{% endif %}>‰Ωé</option>
                        </select>
                        
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-search text-gray-600"></i>
                        <input
                            type="text"
                            name="keyword"
                            placeholder="„Çø„Çπ„ÇØ„ÇíÊ§úÁ¥¢..."
                            value="{{ keyword or '' }}"
                            class="border border-gray-300 rounded-lg px-4 py-2 w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            onkeydown="if(event.key === 'Enter'){ this.form.submit(); }"
                        />
                    </div>
                    </form>
                </div>
            </div>

            <div class="space-y-6">
                {% for task in tasks %}
                <div
                    class="task-card bg-white rounded-xl shadow-lg overflow-hidden {{ task.border_color }}"
                >
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <h3 class="text-xl font-semibold text-gray-800 mr-3">
                                        {{ task.title }}
                                    </h3>
                                    <span
                                        class="priority-{{ task.priority }} px-3 py-1 rounded-full text-xs font-medium"
                                    >
                                        <i class="{{ task.priority_icon }} mr-1"></i
                                        >{{ task.priority_label }}
                                    </span>
                                    <span
                                        class="status-{{ task.status }} px-3 py-1 rounded-full text-xs font-medium ml-2"
                                    >
                                        <i class="{{ task.status_icon }} mr-1"></i
                                        >{{ task.status_label }}
                                    </span>
                                </div>
                                <div id="desc-{{ task.id }}" class="hidden text-gray-600 mt-2 mb-4 whitespace-pre-line">
                                {{ task.description }}
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div class="flex items-center text-gray-600">
                                        <i
                                            class="fas fa-calendar-alt mr-2 text-blue-500"
                                        ></i>
                                        <div>
                                            <span class="font-medium">ÊúüÈôê:</span>
                                            <div id="deadline-{{ task.id }}" class="due-date">
                                                {{ task.due_date }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center text-gray-600">
                                        <i class="fas fa-flag mr-2 text-purple-500"></i>
                                        <div>
                                            <span class="font-medium">ÂÑ™ÂÖàÂ∫¶:</span>
                                            <div>
                                                {% if task.priority == 'È´ò' %}
                                                    È´ò
                                                {% elif task.priority == '‰∏≠' %}
                                                    ‰∏≠
                                                {% elif task.priority == '‰Ωé' %}
                                                    ‰Ωé
                                                {% else %}
                                                    Êú™Ë®≠ÂÆö
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center text-gray-600">
                                        <i class="fas fa-info-circle mr-2 text-indigo-500"></i>
                                        <div class="task-status" data-task-id="{{ task.id }}" data-status="{{ task.status }}">
                                            <span class="font-medium">Áä∂ÊÖã:</span>
                                            <div>
                                                {% if task.status == 'ÈÄ≤Ë°å‰∏≠' %}
                                                    ÈÄ≤Ë°å‰∏≠
                                                {% elif task.status == 'ÂÆå‰∫Ü' %}
                                                    ÂÆå‰∫Ü
                                                {% elif task.status == '‰øùÁïô' %}
                                                    ‰øùÁïô
                                                {% else %}
                                                    Êú™Ë®≠ÂÆö
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center text-gray-600">
                                        <i
                                            class="fas fa-plus-circle mr-2 text-green-500"
                                        ></i>
                                        <div>
                                            <span class="font-medium">‰ΩúÊàêÊó•:</span>
                                            <div>{{ task.created_at|to_jst }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center text-gray-600">
                                        <i class="fas fa-edit mr-2 text-orange-500"></i>
                                        <div>
                                            <span class="font-medium">Êõ¥Êñ∞Êó•:</span>
                                            <div>{{ task.updated_at|to_jst }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex items-center justify-between pt-4 border-t border-gray-100"
                        >
                            <div class="flex items-center space-x-2">
                                {% for tag in task.tags %}
                                <span
                                    class="{{ tag.bg }} {{ tag.text }} px-3 py-1 rounded-full text-xs"
                                >
                                    <i class="{{ tag.icon }} mr-1"></i>{{ tag.name }}
                                </span>
                                {% endfor %}
                            </div>
                            <div class="flex space-x-2">
                                <button
                                    class="action-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                    data-task-id="{{ task.id }}"
                                    data-action="description"
                                    >
                                    <i class="fas fa-eye mr-1"></i>Ë©≥Á¥∞
                                </button>
                                <button
                                    class="action-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                    data-task-id="{{ task.id }}"
                                    data-action="edit"
                                    >
                                    <i class="fas fa-edit mr-1"></i>Á∑®ÈõÜ
                                </button>
                                <button
                                    class="action-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                                    data-task-id="{{ task.id }}"
                                    data-action="delete"
                                    >
                                    <i class="fas fa-trash mr-1"></i>ÂâäÈô§
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
            <div class="text-center">
                <div class="text-red-500 text-6xl mb-4">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</h3>
                <p class="text-gray-600 mb-8">„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åô„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì„ÄÇ<br>Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü</p>
                <div class="flex gap-4 justify-center">
                    <button 
                        onclick="executeDelete(currentDeleteTaskId)" 
                        class="delete-btn btn-hover text-white px-6 py-3 rounded-xl font-semibold shadow-lg"
                    >
                        ÂâäÈô§„Åô„Çã
                    </button>
                    <button 
                        onclick="closeDeleteModal()" 
                        class="cancel-btn btn-hover text-white px-6 py-3 rounded-xl font-semibold shadow-lg"
                    >
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        //id„ÇíÊ∏°„Åô„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÂÆöÁæ©
        let currentDeleteTaskId = null;

        // Á∞°Âçò„Å™„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñÊ©üËÉΩ
        document.addEventListener('DOMContentLoaded', function () {
            // „Çø„Çπ„ÇØ„Ç´„Éº„Éâ„ÅÆ„Éõ„Éê„ÉºÂäπÊûú
            const taskCards = document.querySelectorAll('.task-card');
            taskCards.forEach((card) => {
                card.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-4px)';
                });
                card.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0)';
                });
            });

            // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            const buttons = document.querySelectorAll('.action-btn');
            buttons.forEach((button) => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const action = this.dataset.action;
                    const taskId = this.dataset.taskId;

                    if (!action || !taskId) return;

                    if (action === 'edit')
                    {
                        location.href = `/tasks/${taskId}/edit`;
                    } 
                    else if (action === 'delete') {
                    // ÂâäÈô§„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè„Å™„Å©
                    confirmDelete(taskId);
                    }
                    else if (action === 'description')
                    {
                        const desc = document.getElementById('desc-' + taskId);
                        if (desc) {
                            desc.classList.toggle('hidden');
                            // „Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂàá„ÇäÊõø„Åà„Åü„ÅÑÂ†¥Âêà„ÅØ‰ª•‰∏ã„Çí‰Ωø„ÅÜ
                            const icon = this.querySelector('i');
                            if (desc.classList.contains('hidden')) {
                                this.innerHTML = '<i class="fas fa-eye mr-1"></i>Ë©≥Á¥∞';
                            } else {
                                this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Èñâ„Åò„Çã';
                            }
                        }
                    }
                });
            });

            
            // Êñ∞Ë¶è„Çø„Çπ„ÇØ‰ΩúÊàê„Éú„Çø„É≥
            const newTaskBtn = document.getElementById('newTaskBtn');
            if (newTaskBtn) {
                newTaskBtn.addEventListener('click', function () {
                    location.href = "/tasks/new";
                });
            }
            });

            //
            const profileBtn = document.getElementById('profileBtn');
            if(profileBtn) {
                profileBtn.addEventListener('click', function() {
                    location.href = "profile";
                });
            }

            // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                        try {
                        const res = await fetch('/logout', { method: 'POST' });
                        if (res.ok) {
                            alert('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
                            location.href = '/login'; 
                        } else {
                            alert('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        }
                        } catch {
                        alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                        }
                            }
                });
            }

        // ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´
        function confirmDelete(taskId) {
            currentDeleteTaskId = taskId; // „Çø„Çπ„ÇØID„Çí‰øùÂ≠ò
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');
        }

        function closeDeleteModal() {
            currentDeleteTaskId =  null; // „Çø„Çπ„ÇØID„ÇíÂâäÈô§
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');
        }

        async function executeDelete(){
            if (!currentDeleteTaskId) {
            alert("ÂâäÈô§„Åô„Çã„Çø„Çπ„ÇØ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
            return;
            }
            try
            {
                const response = await fetch(`/tasks/${currentDeleteTaskId}/delete`,
                {
                    method:"POST"
                });
                if (response.ok)
                {
                    alert(`„Çø„Çπ„ÇØ${currentDeleteTaskId}„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
                    location.reload();
                }
                else
                {
                    alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
            catch
            {
                alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        document.querySelectorAll('.task-status').forEach(elem => {
        const status = elem.dataset.status;  // ‰æã: 'ÈÄ≤Ë°å‰∏≠', 'ÂÆå‰∫Ü' „Å™„Å©
        const dueDateElem = document.getElementById('deadline-' + elem.dataset.taskId);
        if (!dueDateElem) return;

        const dueDateStr = dueDateElem.textContent.trim();
        const now = new Date();
        const deadline = new Date(dueDateStr);
        const diffDays = (deadline - now) / (1000 * 60 * 60 * 24);

        // ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        if (status === 'ÂÆå‰∫Ü') return;

        if (diffDays >= 0 && diffDays <= 7) {
            // ‰ªäÊó•„Åã„Çâ7Êó•‰ª•ÂÜÖ„ÅÆÊúüÈôê„ÅØËµ§„Åè„Åô„Çã
            dueDateElem.classList.add('text-red-600');
        } else if (diffDays < 0) {
            // ÊúüÈôêÈÅé„Åé„ÇÇËµ§„Åè„Åô„ÇãÔºà‰ªªÊÑèÔºâ
            dueDateElem.classList.add('text-red-600');
        }
        });

        // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>